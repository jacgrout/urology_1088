---
title: "Urology"
author: "Jacqueline Grout"
echo: false
warning: false
format: html
editor: visual
---

```{r}
#| echo: false
load(file = "data/projectimage.RData")
source("R/functions.R")

midlandsoutpatients <- readRDS("midlandsoutpatients.rds")
```

## Executive Summary

Yet to be written ...

### Key Findings

hdfhdhdhdfhdhf

### Implications/Recomendations

dhdhfdhdfhdfhdfhfdhh

## Introduction

There are concerns that the provision of some urology services, particularly functional urology,Â  is not meeting the needs of patients adequately. This gap in provision could lead to delayed or prevented diagnosis and treatment resulting in poor quality of life and negative health outcomes for patients. The aim of this project is to produce a quantitative analysis to explore and quantify the underlying level of need in the Midlands for a selection of common functional urological conditions and using that to begin to quantify the scale of some of the gaps in Urology provision.

## Methodology

Prevalence studies from the literature for the selected conditions were considered with the aim to obtain detailed age and gender specific prevalence rate estimates.

Insert each of the studies and references here...

Benign Prostatic Hyperplasia:

<https://www.nature.com/articles/s41598-017-06628-8>

Overactive Bladder:

<https://ginegap.com/materiales-cursos/bibliografia/m1-c1/52_Temml_2005.pdf>

Post prostatectomy incontinence:

<https://www.tandfonline.com/doi/full/10.1080/13685538.2017.1369944>

This condition relates only to male patients, of whom 23% are incontinent after 12 months.

For Benign Prostatic Hyperplasia (BPH) and Overactive Bladder the prevalence rates obtained from the literature were applied to the gp practice list sizes to obtain prevalence estimates for each practice and then ..

These rates have been applied to GP list sizes to give an indication of the underlying level of need. The prevalence estimates were applied to GP practice populations and then aggregated to sub ICB and ICB level to provide quantifications of underlying need at both strategic and a more local/operational level.

Treatment to need ratios have been calculated by directly comparing levels of condition specific treatment activity to the prevalence estimates.

Where possible the analysis will consider both hospital surgical treatments (including inpatient, day case and outpatient treatments) using surgical procedure data as well as primary care management using condition specific prescribing data. We will identify all relevant procedure codes and medications for inclusion and confirm these with the project's clinical contacts

### Inpatients

#### Benign Prostatic Hyperplasia:

##### Prevalence

```{r}
#| echo: false
library(sf)
library(tmap)
library(dplyr)
library(stringr)
library(readxl)
library(gt)
library(janitor)
library(readr)
library(tidyr)
library(purrr)



#subicb_bph <- readRDS("subicb_bph.rds")

tmap_options(check.and.fix = TRUE)
tmap_mode("view")

tm_shape(subicb_bph) +
  tm_fill("overall_prev",title="Prevalence BPH",style = "pretty", palette = "Blues") +
  tm_borders("grey25", alpha=.5) 
```

##### Activity Need Ratio

```{r}
#| echo: false
library(StrategyUnitTheme)

#subicb_bph_ratio <- readRDS("subicb_bph_ratio.rds")
#bph_providers_sf <- readRDS("bph_providers_sf.rds")

tm_shape(subicb_bph_ratio) + 
  tm_fill("activityneedratio",title="Activity/Need Ratio BPH",style = "pretty", palette = "-viridis") +
  tm_borders("grey25", alpha=.5) +  
 # tm_shape(bph_providers_sf) + 
#  tm_bubbles(size="num",labels="name") + 
  tm_shape(bph_providers_sf) + 
  tm_dots(col = "grey", size = 0.05,legend.show = T)+
          #col= "short_role",legend.show = T) +
  #tm_text("provider_code")
  tm_basemap(server = c('OpenStreetMap'))
```

#### Overactive Bladder:

##### Prevalence

```{r}
#| echo: false

#subicb_oab <- readRDS("subicb_oab.rds")


tm_shape(subicb_oab) +
  tm_fill("overall_prev",title="Prevalence OAB",style = "pretty", palette = "Greens") +
  tm_borders("grey25", alpha=.5) 
```

Where conditions relate to both male and female patients the results will be stratified by gender to inform an assessment of potential gender inequity in treatment access/provision.

##### Activity Need Ratio

```{r}
#| echo: false

#subicb_oab_ratio <- readRDS("subicb_oab_ratio.rds")
#oab_providers_sf <- readRDS("oab_providers_sf.rds")

tm_shape(subicb_oab_ratio) +
  tm_fill("activityneedratio",title="Activity/Need Ratio OAB",style = "pretty", palette = "-viridis") +
  tm_borders("grey25", alpha=.5) +
  tm_shape(oab_providers_sf) + 
  tm_dots(col = "short_role",size = 0.05)+
  tm_basemap(server = c('OpenStreetMap'))
```

#### Post Prostatectomy Incontinence:

##### Prevalence

```{r}
#| echo: false

#subicb_ppi <- readRDS("subicb_ppi.rds")

tm_shape(subicb_ppi) +
  tm_fill("overall_prev",title="Prevalence PPI",style = "pretty", palette = "Reds") +
  tm_borders("grey25", alpha=.5)
```

##### Activity Need Ratio

```{r}
#| echo: false

#subicb_ppi_ratio <- readRDS("subicb_ppi_ratio.rds")
#ppi_providers_sf <- readRDS("ppi_providers_sf.rds")


tm_shape(subicb_ppi_ratio) +
  tm_fill("activityneedratio",title="Activity/Need Ratio PPI",style = "pretty", palette = "-viridis") +
  tm_borders("grey25", alpha=.5) +
  tm_shape(ppi_providers_sf) + 
  tm_dots(col = "short_role",size = 0.05)+
  tm_basemap(server = c('OpenStreetMap'))
```

Funnel plots

```{r}
data <-ICBTOPPI |>
  filter(reg22nm =="Midlands") |>
  mutate(activityneedratio = num_ppi_spells / numtotal)
         
ubar <- sum(data$num_ppi_spells)/sum(data$numtotal)


#sub_icb <- midlands_sub_icbs[[i]]

cl_fn <- function(ubar, limit) {
  \(x) ubar + limit * sqrt(ubar / x)
}


plots <-midlands_sub_icbs |>
  set_names() |>
  map(\(sub_icb) {
    ggplot(data, aes(numtotal, activityneedratio)) +
      geom_jitter(
        data = \(.x) filter(.x, sub_icb_location_code == sub_icb),
        fill = "#f9bf07",
        colour = "black",
        shape="circle filled"
      ) +
      # geom_jitter(
      #   data = \(.x) {
      #     .x |>
      #       filter(sub_icb_location_code != sub_icb)
      #   },
      #   alpha = 0.1,
      #   size = 0.5
      #     ) +
      geom_hline(aes(yintercept=ubar),size=1) +
      geom_text_repel(
        data = \(.x) {
          .x |>
            filter(
              sub_icb_location_code == sub_icb,
              FALSE |
                activityneedratio > cl_fn(ubar, 3.0)(numtotal) |
                activityneedratio < cl_fn(ubar, -3.0)(numtotal)
            )
        },
        aes(label = org_code)
      ) +
      geom_function(fun = cl_fn(ubar, +1.96), size = 0.5, linetype=5) +
      geom_function(fun = cl_fn(ubar, -1.96), size = 0.5, linetype=5) +
      geom_function(fun = cl_fn(ubar, +3.00), size = 0.5, linetype="solid") +
      geom_function(fun = cl_fn(ubar, -3.00), size = 0.5, linetype="solid") +
      xlab("Prevalence Number") +
      ylab("Activity to Need Ratio")+
      labs(title = "Funnel plot for Post Prostatectomy Incontinence", 
           subtitle = paste0("Sub-ICB: ",sub_icb)) +
      su_theme() 
  })

plots
```

### Outpatients

There were 2.3 million (2,304,785) Urology outpatient attendances in the Midlands region in the five-year period April 2018 to March 2023.

```{r}

table_data <-midlandsoutpatients |>
  filter(der_appointment_type != "N/A") |>
  group_by(der_financial_year,der_appointment_type) |>
  summarise(total = sum(numattends)) |>
  ungroup()

table_data|> 
  pivot_wider(names_from = der_appointment_type, values_from = total, id_cols = der_financial_year) |>
gt(rowname_col = "der_financial_year")|>
  cols_move(FUp, New) |>
  tab_header(
    title = 'Urology Outpatient Attendances - Midlands'
  ) |>
  tab_source_note(source_note = "Data: SUS")
    
```

The Urology outpatient data rarely includes diagnosis codes (only 4% of attendances). Procedures that take place in outpatients are also not consistently recorded. Consequently it's not possible to give a robust picture of activity in relation to these conditions. Below can be seen ...

Maybe need to put the above data per 1000 list size pop for the ICB?

```{r}


icblistsize <- ICBTOBPH |>
   group_by(icb22nm,icb22) |>
   summarise(icb_list_size=sum(list_size_bph_total))|>
   filter(icb22 %in% midlands_icbs) |>
   ungroup()

midlandsoutpatientsicb <-
midlandsoutpatients |>
  group_by(icb22nm) |>
  summarise(totalProcs = sum(der_number_procedure),
            totalattends = sum(numattends)) |>
  ungroup()

midlandsoutpatientsicb <- midlandsoutpatientsicb |>
  left_join(icblistsize) |>
  mutate(attendperthousand = (totalattends/icb_list_size)*1000)

# BARPLOT

bar_yields <- midlandsoutpatientsicb %>% 
  #select(-totalProcs) %>% 
  rowwise() %>% 
  ungroup() %>% 
  select(icb22nm, icb22, totalProcs, totalattends, attendperthousand) %>% 
  mutate(
    bar = round(attendperthousand/max(attendperthousand)*100, digits = 2),
    color = col_pal(bar),
    bar_chart = bar_chart(bar, color = color),
    bar_chart = map(bar_chart, ~gt::html(as.character(.x)))
    ) %>% 
  select(-bar, -color, -icb22)

# BARPLOT

rule10_bar <- bar_yields %>% 
  gt() %>% 
  cols_width(vars(bar_chart) ~ px(100),
             vars(totalProcs) ~ px(75),
             vars(totalattends) ~ px(75),
             vars(attendperthousand) ~ px(75),
  ) %>% 
  cols_label(
    totalProcs = md("Outpatient Procedures"),
    totalattends = md("Outpatient Attendances"),
    attendperthousand = md("Outpatient Attends /1000 List Size"),
    icb22nm = md("ICB"),
    bar_chart = ""
  ) %>% 
  cols_align(
    align = "right",
    columns = 2:5
  ) %>% 
  cols_align(
    align = "left",
    columns = vars(bar_chart)
  ) %>% 
  fmt_number(columns = 2:3,
             decimals=0) %>% 
  fmt_number(columns = 4:4,
             decimals=2) %>% 
  tab_style(
    style = cell_text(color = "black", weight = "bold"),
    locations = list(
      cells_column_labels(everything())
    )
  ) %>%  
  tab_options(
    row_group.border.top.width = px(3),
    row_group.border.top.color = "black",
    row_group.border.bottom.color = "black",
    table_body.hlines.color = "white",
    table.border.top.color = "white",
    table.border.top.width = px(3),
    table.border.bottom.color = "white",
    table.border.bottom.width = px(3),
    table_body.border.bottom.width = px(2),
    table_body.border.bottom.color = "black",
    column_labels.border.bottom.color = "black",
    column_labels.border.bottom.width = px(3)
  )
# %>% 
#   tab_footnote(footnote = "Source: SUS April 2018 - March 2023",
#                locations = cells_column_labels(
#                  columns =2:4
#                )) 

rule10_bar

```

### Prescribing

Another

## Conclusion

fsgsgsdggs

## Appendix

### PPI:

ICD10 Code: N39

OPCS codes:

Medications:
